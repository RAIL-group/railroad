name: Install, typechecking, and tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read


jobs:
  uv-example:
    runs-on: ubuntu-latest
    env:
      RESOURCE_CACHE_DIR: ${{ github.workspace }}/.cache/resources-cache

    steps:
      - uses: actions/checkout@v6

      - name: Restore cached resources
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.RESOURCE_CACHE_DIR }}
          key: resources-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            resources-${{ runner.os }}-

      - name: Populate resources/ from cache
        run: |
          mkdir -p resources
          if [ -d "${RESOURCE_CACHE_DIR}" ]; then
            rsync -a "${RESOURCE_CACHE_DIR}/" resources/
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install system deps for X/GL
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb mesa-utils \
            libgl1 libgl1-mesa-dri libglib2.0-0 libsm6 libxrender1 libxext6

      - name: Install the project
        run: uv sync


      - name: Run typechecking
        run: uv run ty check

      - name: Run railroad tests
        env:
          DISPLAY: ":99"
        run: |
          xvfb-run -a -s "-screen 0 1280x1024x24" uv run pytest packages/railroad --ignore=packages/railroad/tests/environment/procthor

      - name: Update resource cache from resources/
        if: always()
        run: |
          mkdir -p "${RESOURCE_CACHE_DIR}"
          rsync -a resources/ "${RESOURCE_CACHE_DIR}/"

      - name: Save resources cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.RESOURCE_CACHE_DIR }}
          key: resources-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
